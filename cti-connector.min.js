var Cti={EVENT:{READY:"READY",LOGGED_IN:"LOGGED_IN",LOGGED_OUT:"LOGGED_OUT",INITIAL:"INITIAL",ACCEPTED:"ACCEPTED",RINGING:"RINGING",CONNECTED:"CONNECTED",ON_HOLD:"ON_HOLD",HANGUP:"HUNGUP",CANCEL:"CANCEL",INFO:"INFO",ERROR:"ERROR"},DIRECTION:{IN:"INBOUND",OUT:"OUTBOUND"},TYPE:{ERROR:"error",CHAT:"chat",HEADLINE:"headline",UNAVAILABLE:"unavailable"},CALL_STATUS:{INITIAL:"INITIAL",ACCEPTED:"ACCEPTED",RINGING:"RINGING",ON_HOLD:"ON_HOLD",CONNECTED:"CONNECTED",HANGUP:"HANGUP"},CALL_CODE:{RINGING:/^1\d{2}$/,ACCEPTED:200,REDIRECTED:/^3\d{2}$/,NO_ANSWER:487,UNREACHABLE:408,NOT_FOUND:/^4\d{2}$/,REJECTED:/^[5|6]\d{2}$/},log:function(e){window.console&&("string"==typeof e&&(e="Cti: "+e),console.info(e))},Connector:function(e){var t=this;"undefined"!=typeof SIP?(t.connected=!1,t.apiEndpoint="https://l7api.com/v1.1/voipstudio",t.callbacks={onMessage:e.onMessage},t._hasActiveConnection()&&t._reconnect()):console.error("SIP dependency missing")}};Cti.Connector.prototype={ua:null,subscriptions:{},calls:{},keepAliveTimer:null,isConnected:function(){return this.log("isConnected() "+this.connected),this.connected},log:function(e){window.console&&console.log("Cti.Connector: "+e)},login:function(){var n=this;if(n.ua&&this.ua.isConnected())return n.log("Already connected"),n.connected=!0,void n._sendEvent({name:Cti.EVENT.LOGGED_IN,message:"User is already authenticated."});if(0===arguments.length||2<arguments.length)n._sendErrorEvent("Invalid aruments number while login.");else{var e,t,r,i;if(1==arguments.length){var s=arguments[0];if(2!==(s=s.split(":")).length)return void n._sendErrorEvent("Invalid API Key format, please enter <user_id:api_key>.");e=s[0],t=s[1]}else if(r=arguments[0],i=arguments[1],0===r.length||0===i.length)return void n._sendErrorEvent("Missing username and/or password.");var o=function(t){n._corsRequest({method:"GET",url:"/me",credentials:t,success:function(e){n.log("ajax login SUCCESS"),n._setParam("user_id",t.user_id),n._setParam("user_token",t.user_token),n.connected=!0,n._sendEvent({name:Cti.EVENT.LOGGED_IN,message:"User has been successfully authenticated."}),n._connect(e.data.id,e.data.sip_password,e.data.sip_domain)},failure:function(){n.log("ajax login FAIL - user data failure"),n._sendErrorEvent("Unable to login - user data failure")}})};t?o({user_id:e,user_token:t}):n._corsRequest({method:"POST",url:"/login",data:{email:r,password:i},success:function(e){e.user_id&&e.user_token?o(e):n._sendErrorEvent("user_id and/or user_token missing in API response.")},failure:function(e,t){n._sendErrorEvent(n.getApiError(t))}})}},logout:function(){var e=this;if(e.keepAliveTimer&&clearInterval(e.keepAliveTimer),e.isConnected())return e.apiRequest("POST","/logout"),e.connected=!1,e.ua.isConnected()&&e.ua.stop(),e._setStorage("l7_connector",{}),e._sendEvent({name:Cti.EVENT.LOGGED_OUT,message:"User has been successfully logged out."});e._sendErrorEvent("Connector is not connected.")},answer:function(){var e=this;if(this.isConnected()){var t=null;for(var n in e.calls){var r=e.calls[n];r.direction==Cti.DIRECTION.IN&&r.status==Cti.CALL_STATUS.RINGING&&(t=n)}t?e.apiRequest("PATCH","/calls/"+t,{state:"CONNECTED"}):e._sendErrorEvent("No ringing inbound calls to answer.")}else e._sendErrorEvent("Connector need to be connected first.")},call:function(e){var r=this;if(r.isConnected())if(void 0!==e)if(0!==e.length){if(5<e.length){if(e=r._formatE164(e),!r._isPhoneNumberValid(e))return void r._sendErrorEvent("Phone number: "+e+" has invalid format")}else if(r._getParam("sip_username")==e)return void r._sendErrorEvent("You are unable to call to yourme.");e=e.replace(/^\+/,"");var i=new Date/1,s={id:"initial-"+i,destination:e,direction:Cti.DIRECTION.OUT,status:Cti.CALL_STATUS.INITIAL};r._sendEvent({name:Cti.EVENT.INITIAL,call:s}),r.apiRequest("POST","/calls",{to:e},function(){r._sendEvent({name:Cti.EVENT.ACCEPTED,call:s})},function(e,t){if(400==e)r._sendErrorEvent(r.getApiError(t));else{var n=new Date/1-i;s.cause=n<1e3?"SIP Endpoint not found":"SIP Endpoint rejected call",r._sendEvent({name:Cti.EVENT.CANCEL,call:s})}})}else r._sendErrorEvent("Destination number is empty");else r._sendErrorEvent("Missing destination parameter");else r._sendErrorEvent("Connector need to be connected first.")},terminate:function(e){var t=this;if(t.isConnected())if(void 0!==e)if(t.calls[e]){var n=t.calls[e];-1!=[Cti.CALL_STATUS.CONNECTED,Cti.CALL_STATUS.ON_HOLD].indexOf(n.status)?t.apiRequest("DELETE","/calls/"+e):t._sendInfoEvent("Call with STATUS: "+n.status+" cannot be terminated.")}else t._sendErrorEvent("Call with ID: "+e+" could not be found.");else t._sendErrorEvent("Missing call ID parameter");else t._sendErrorEvent("Connector need to be connected first.")},transfer:function(e,t){var n=this;if(n.isConnected())if(void 0!==e)if(void 0!==t)if(n.calls[e]){var r=n.calls[e];if(r.status===Cti.CALL_STATUS.CONNECTED)if(0!==t.length){if(5<t.length){if(t=n._formatE164(t),!n._isPhoneNumberValid(t))return void n._sendErrorEvent("Phone number: "+t+" has invalid format")}else{if(!n._isExtensionValid(t))return void n._sendErrorEvent("Extension number: "+t+" has invalid format");if(n._getParam("sip_username")==t)return void n._sendErrorEvent("You are unable to transfer call to yourme.")}t=t.replace(/^\+/,""),n.calls[e].destination=t,n.apiRequest("PATCH","/calls/"+e,{dst:t})}else n._sendErrorEvent("Destination number is empty");else n._sendInfoEvent("Call with STATUS: "+r.status+" cannot be transfered.")}else n._sendErrorEvent("Call with ID: "+e+" could not be found.");else n._sendErrorEvent("Missing destination parameter");else n._sendErrorEvent("Missing call ID parameter");else n._sendErrorEvent("Connector need to be connected first.")},subscribe:function(e){var t=this;if(void 0!==e)if(t.ua.isConnected()){var n=e.split(":");if(2==n.length){var r=n.shift(),i=n.shift();if(["user","ivr","queue","conf"].indexOf(r)<0)this._sendErrorEvent("Invalid node type.");else{var s=("user"==r?i:r+"-"+i)+"@"+t._getParam("sip_domain");if(!t.subscriptions[s]){t.log("Cti.connector.subscribe ["+s+"]");var o=t.ua.subscribe(s,"dialog",{expires:300});return(t.subscriptions[s]=o).on("notify",function(e){t.parseNotify(e)}),o}t.log("Already subscribed to ["+s+"], skipping...")}}else this._sendErrorEvent("Invalid node format.")}else t._sendErrorEvent("Connector need to be connected first.");else t._sendErrorEvent("Missing node parameter.")},apiRequest:function(e,t,n,r,i){var s=this,o={method:e,url:t,credentials:{user_id:s._getParam("user_id"),user_token:s._getParam("user_token")},success:function(e){"function"==typeof r&&r(e)},failure:function(e,t){"function"==typeof i?i(e,t):s._sendErrorEvent(s.getApiError(t))}};n&&(o.data=n),s._corsRequest(o)},getApiError:function(e){var t=[];if(e.message&&t.push(e.message),e.errors)for(var n=0;n<e.errors.length;n++)t.push(e.errors[n].field+": "+e.errors[n].message);return 0<t.length?t.join(" "):"Unknown API Error"},parseNotify:function(e){for(var t=(new DOMParser).parseFromString(e.request.body,"text/xml").getElementsByTagName("dialog"),n=0;n<t.length;n++){var r=t[n],i=r.id.split("-"),s={id:i[0],dialog_id:r.id,direction:null,state:null,remote:null,remote_name:null,local:null,local_name:null,context:null,duration:0};s.direction=r.getAttribute("direction"),r.getElementsByTagName("state").length&&(s.state=r.getElementsByTagName("state")[0].childNodes[0].nodeValue);var o=r.getElementsByTagName("remote");if(o.length){var a=o[0];if(a.getElementsByTagName("identity").length){var l=a.getElementsByTagName("identity")[0].childNodes[0].nodeValue;s.remote_name=a.getElementsByTagName("identity")[0].getAttribute("display").replace("&lt;","<").replace("&gt;",">"),i=l.split("@"),s.remote=i[0].substring(4)}}var c=r.getElementsByTagName("local");if(c.length){var d=c[0];if(d.getElementsByTagName("identity").length){var u=d.getElementsByTagName("identity")[0].childNodes[0].nodeValue;s.local_name=d.getElementsByTagName("identity")[0].getAttribute("display").replace("&lt;","<").replace("&gt;",">"),i=u.split("@"),s.local=i[0].substring(4)}for(var E=d.getElementsByTagName("target")[0].getElementsByTagName("param"),_=0;_<E.length;_++){var g=E[_],m=g.getAttribute("pname"),f=g.getAttribute("pval");if("+sip.rendering"==m&&"no"==f&&(s.state="onhold"),"timestamp.start"==m){var v=new Date,p=Math.round(v.getTime()/1e3);s.duration=p-parseInt(f)}"context"==m&&(s.context=f)}}var C,N={id:s.id,cid:s.dialog_id,cause:"",direction:"receiver"==s.direction?Cti.DIRECTION.IN:Cti.DIRECTION.OUT,destination:"receiver"==s.direction?s.local:s.remote,destinationName:"receiver"==s.direction?s.local_name:s.remote_name,source:"receiver"==s.direction?s.remote:s.local,sourceName:"receiver"==s.direction?s.remote_name:s.local_name};"confirmed"==s.state&&(N.status=Cti.CALL_STATUS.CONNECTED,C=Cti.EVENT.CONNECTED),"early"==s.state&&(N.status=Cti.CALL_STATUS.RINGING,C=Cti.EVENT.RINGING),"onhold"==s.state&&(N.status=Cti.CALL_STATUS.ON_HOLD,C=Cti.EVENT.ON_HOLD),"terminated"==s.state&&(N.status=Cti.CALL_STATUS.HANGUP,C=Cti.EVENT.HANGUP),this.calls[s.id]=N,this._sendEvent({name:C,call:N})}},_connect:function(e,t,n){var r=this;e?t?n?(r.ua=new SIP.UA({uri:e+"@"+n,traceSip:!1,log:{builtinEnabled:!1},userAgentString:"CTI Connector",wsServers:["wss://"+n+":443"],authorizationUser:e,password:t,register:!1,sessionDescriptionHandlerFactoryOptions:{peerConnectionOptions:{rtcConfiguration:{iceServers:[]}}}}),r.ua.on("connecting",function(){r.log("SIP Connecting..."),r.subscriptions={}}),r.ua.on("connected",function(){r.connected=!0,r._setParam("sip_username",e),r._setParam("sip_password",t),r._setParam("sip_domain",n),r._onConnected()}),r.ua.on("disconnected",function(){r.log("SIP Disconnected..."),r.subscriptions={}})):r._sendErrorEvent("Empty sip_domain given"):r._sendErrorEvent("Empty sip_password given"):r._sendErrorEvent("Empty sip_username given")},_reconnect:function(){var e=this;e._getStorage("l7_connector")?(e.log("re-connecting..."),e.apiRequest("GET","/ping",null,function(){e._connect(e._getParam("sip_username"),e._getParam("sip_password"),e._getParam("sip_domain"))},function(){return e._setStorage("l7_connector",{}),e.keepAliveTimer&&clearInterval(e.keepAliveTimer),e._sendEvent({name:Cti.EVENT.LOGGED_OUT,message:"User session expired."})})):e._sendErrorEvent("You need to login first in order to be able to connect to SIP server.")},_hasActiveConnection:function(){return!!(this._getParam("sip_username")&&this._getParam("sip_password")&&this._getParam("sip_domain"))},_onError:function(e){Strophe.Status.ERROR},_onConnected:function(){var e=this;e.log("Connected"),e.subscribe("user:"+e._getParam("sip_username")),e.keepAliveTimer||(e.keepAliveTimer=setInterval(function(){e.apiRequest("GET","/ping",null,function(){},function(){return e._setStorage("l7_connector",{}),e._sendEvent({name:Cti.EVENT.LOGGED_OUT,message:"User session expired."})})},25e3)),e._sendEvent({name:Cti.EVENT.READY,message:"Connection with SIP server has been successfully established."})},_corsRequest:function(n){var r=this._newXHR();r.open(n.method,this.apiEndpoint+n.url,!0),r.setRequestHeader("Content-Type","application/json"),n.credentials&&r.setRequestHeader("Authorization","Basic "+btoa(n.credentials.user_id+":"+n.credentials.user_token)),r.onreadystatechange=function(){if(4===r.readyState){var t;if(r.responseText)try{t=JSON.parse(r.responseText)}catch(e){return void n.failure(r.status,t)}200<=r.status&&r.status<400?n.success(t):n.failure(r.status,t)}},n.data?r.send(JSON.stringify(n.data)):r.send()},_newXHR:function(){var t=null;if(window.XDomainRequest){this.log("using XdomainRequest for IE");var n=function(e,t){e.status=t,e.readyState=4;try{e.onreadystatechange()}catch(e){}};(t=new XDomainRequest).readyState=0,t.onload=function(){var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(t.responseText),t.responseXML=e,n(t,200)},t.onerror=function(){n(t,500)},t.ontimeout=function(){n(t,500)}}else window.XMLHttpRequest?(this.log("using XMLHttpRequest"),(t=new XMLHttpRequest).overrideMimeType&&t.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(this.log("using ActiveXObject"),t=new ActiveXObject("Microsoft.XMLHTTP"));return t},_nodeToArray:function(e){for(var t=e.childNodes,n={},r=0;r<t.length;r++){var i=(e=t[r]).textContent||e.text;n[e.nodeName]=i}return n},_formatE164:function(e){return"+"+e.replace(/\+|-|\.|\(|\)| /g,"").replace(/^0{1,2}/g,"")},_isPhoneNumberValid:function(e){return/^\+[1-9][0-9]{5,16}$/.test(e)},_isExtensionValid:function(e){return/^[1-9][0-9]{3,4}$/.test(e)},_sendEvent:function(e){this.callbacks.onMessage(e)},_sendInfoEvent:function(e){this._sendEvent({name:Cti.EVENT.INFO,message:e})},_sendErrorEvent:function(e){this._sendEvent({name:Cti.EVENT.ERROR,message:e})},_setParam:function(e,t){var n=this._getParams();return n[e]=t,this._setStorage("l7_connector",n),this},_getParam:function(e,t){var n=this._getParams();return void 0!==n[e]?n[e]:t},_getParams:function(){return this._getStorage("l7_connector",{})},_getStorage:function(e,t){var n=localStorage.getItem(e);if(!n)return t;var r=JSON.parse(n);return r||t},_setStorage:function(e,t){localStorage.setItem(e,JSON.stringify(t))},_removeStorage:function(e){localStorage.removeItem(e)},_isSecured:function(){return"https:"==window.location.protocol}};