/*! cti-connector.js v1.0.4 - built on 09-09-2015 */
Cti={EVENT:{READY:"READY",LOGGED_IN:"LOGGED_IN",LOGGED_OUT:"LOGGED_OUT",INITIAL:"INITIAL",ACCEPTED:"ACCEPTED",RINGING:"RINGING",CONNECTED:"CONNECTED",ON_HOLD:"ON_HOLD",HANGUP:"HUNGUP",CANCEL:"CANCEL",INFO:"INFO",ERROR:"ERROR"},DIRECTION:{IN:"INBOUND",OUT:"OUTBOUND"},TYPE:{ERROR:"error",CHAT:"chat",HEADLINE:"headline",UNAVAILABLE:"unavailable"},CALL_STATUS:{INITIAL:"INITIAL",ACCEPTED:"ACCEPTED",RINGING:"RINGING",ON_HOLD:"ON_HOLD",CONNECTED:"CONNECTED",HANGUP:"HANGUP"},CALL_CODE:{RINGING:/^1\d{2}$/,ACCEPTED:200,REDIRECTED:/^3\d{2}$/,NO_ANSWER:487,UNREACHABLE:408,NOT_FOUND:/^4\d{2}$/,REJECTED:/^[5|6]\d{2}$/},log:function(a){window.console&&("string"==typeof a&&(a="Cti: "+a),console.info(a))}},"undefined"!=typeof Strophe&&(Strophe.log=function(a,b){a>=Strophe.LogLevel.INFO&&window.console&&console.log("STROPHE LOG: "+a+" "+b)}),Cti.Connector=function(a){this.connected=!1,this.apiLoginUrl="https://ssl7.net/voipstudio.com/u/api/login",this.callbacks={onMessage:a.onMessage},this.xhr=this._newXHR(),this._hasActiveConnection()&&this._reconnect()},Cti.Connector.prototype={isConnected:function(){return this.log("isConnected() "+this.connected),this.connected},log:function(a){window.console&&console.log("Cti.Connector: "+a)},login:function(a,b){if(this._connection instanceof Strophe.Connection&&this._connection.connected)return this.log("Already connected"),this.connected=!0,void this._sendEvent({name:Cti.EVENT.LOGGED_IN,message:"User is already authenticated."});if(0===a.length||0===b.length)return void this._sendErrorEvent("Missing username and/or password.");var c=this,d={api_email:a,api_password:b,protocol:"xmpp"};this.xhr.open("POST",this.apiLoginUrl,!0),"withCredentials"in this.xhr&&(this.xhr.withCredentials=!0),this.xhr.onreadystatechange=function(){if(4===c.xhr.readyState)if(200===c.xhr.status||304===c.xhr.status){var a=JSON.parse(c.xhr.responseText);a.success?(c.log("ajax login SUCCESS"),c._setCalls({}),c.connected=!0,c._sendEvent({name:Cti.EVENT.LOGGED_IN,message:"User has been successfully authenticated."}),c._connect(a.xmpp_username,a.xmpp_password,a.xmpp_domain)):c._sendErrorEvent(a.error)}else c.log("ajax login FAIL"),c._sendErrorEvent("Unable to login")},this.xhr.send(this._serialize(d))},logout:function(){return this.isConnected()?(this.connected=!1,this._setCookie("l7_connector",{}),this._connection.connected&&this._connection.disconnect("logout"),this._sendEvent({name:Cti.EVENT.LOGGED_OUT,message:"User has been successfully logged out."})):void this._sendErrorEvent("Connector is not connected.")},call:function(a){if(!this.isConnected())return void this._sendErrorEvent("Connector need to be connected first.");if("undefined"==typeof a)return void this._sendErrorEvent("Missing destination parameter");if(0===a.length)return void this._sendErrorEvent("Destination number is empty");if(a.length>5){if(a=this._formatE164(a),!this._isPhoneNumberValid(a))return void this._sendErrorEvent("Phone number: "+a+" has invalid format")}else if(this._getParam("xmpp_username")==a)return void this._sendErrorEvent("You are unable to call to yourself.");var b=this._uniqid(),c={id:b,cid:"",cause:"",status:"",direction:Cti.DIRECTION.OUT,destination:a,contacts:new Array};this._setCall(b,c),this.log("Call: "+a);var d="/call "+a,e=$msg({to:"cc@"+this._getParam("xmpp_domain"),type:"chat",id:"c2c"+b}).c("body",{},d);this._connection.send(e.tree())},terminate:function(a){if(!this.isConnected())return void this._sendErrorEvent("Connector need to be connected first.");if("undefined"==typeof a)return void this._sendErrorEvent("Missing call ID parameter");if(!this._hasCall(a))return void this._sendErrorEvent("Call with ID: "+a+" could not be found.");var b=this._getCall(a,!0);if([Cti.CALL_STATUS.CONNECTED,Cti.CALL_STATUS.ON_HOLD].indexOf(b.status)==-1)return void this._sendInfoEvent("Call with STATUS: "+b.status+" cannot be terminated.");this.log("HangUp: "+b.cid);var c="/terminate "+b.cid,d=$msg({to:"cc@"+this._getParam("xmpp_domain"),type:"chat",id:"c2c"+b.cid}).c("body",{},c);this._connection.send(d.tree())},transfer:function(a,b){if(!this.isConnected())return void this._sendErrorEvent("Connector need to be connected first.");if("undefined"==typeof a)return void this._sendErrorEvent("Missing call ID parameter");if("undefined"==typeof b)return void this._sendErrorEvent("Missing destination parameter");if(!this._hasCall(a))return void this._sendErrorEvent("Call with ID: "+a+" could not be found.");var c=this._getCall(a,!0);if(c.status!==Cti.CALL_STATUS.CONNECTED)return void this._sendInfoEvent("Call with STATUS: "+c.status+" cannot be transfered.");if(0===b.length)return void this._sendErrorEvent("Destination number is empty");if(b.length>5){if(b=this._formatE164(b),!this._isPhoneNumberValid(b))return void this._sendErrorEvent("Phone number: "+b+" has invalid format")}else{if(!this._isExtensionValid(b))return void this._sendErrorEvent("Extension number: "+b+" has invalid format");if(this._getParam("xmpp_username")==b)return void this._sendErrorEvent("You are unable to transfer call to yourself.")}c.destination=b,this._setCall(a,c),this.log("Transfer: "+c.cid+" "+c.destination);var d="/transfer "+c.cid+" "+c.destination,e=$msg({to:"cc@"+this._getParam("xmpp_domain"),type:"chat",id:"c2c"+c.cid}).c("body",{},d);this._connection.send(e.tree())},subscribe:function(a){if("undefined"==typeof a)return void this._sendErrorEvent("Missing node parameter.");if(!this.isConnected())return void this._sendErrorEvent("Connector need to be connected first.");var b=a.split(":");if(2!=b.length)return void this._sendErrorEvent("Invalid node format.");var c=["user","ivr","queue","conf"],d=b.shift();if(c.indexOf(d)<0)return void this._sendErrorEvent("Invalid node type.");var e=$iq({type:"set",to:"pubsub."+this._getParam("xmpp_domain")}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:a,jid:this._connection.jid});this._connection.send(e)},_connect:function(a,b,c){if(!a)return void this._sendErrorEvent("Empty xmpp_username given");if(!b)return void this._sendErrorEvent("Empty xmpp_password given");if(!c)return void this._sendErrorEvent("Empty xmpp_domain given");var d="https://"+c+"/http-bind",e=a+"@"+c,f=this;this._setParam("xmpp_domain",c),this._setParam("xmpp_username",a),this._connection=new Strophe.Connection(d),this._connection.xmlOutput=function(a){f._setParam("rid",a.getAttribute("rid"))},this._connection.connect(e,b,function(a){f._setParam("sid",f._connection._proto.sid),f._onConnected(a,!1)})},_reconnect:function(){if(!this._getCookie("l7_connector"))return void this._sendErrorEvent("You need to login first in order to be able to connect to XMPP server.");if(!this._getParam("rid")||!this._getParam("sid"))return void this._sendErrorEvent("You need to login first in order to be able to reconnect to XMPP server.");var a="https://"+this._getParam("xmpp_domain")+"/http-bind",b=this;this._connection=new Strophe.Connection(a),this._connection.xmlOutput=function(a){b._setParam("rid",a.getAttribute("rid"))},this.connected=!0;var c=this._getParam("full_jid"),d=this._getParam("sid"),e=parseInt(this._getParam("rid"))+1;this._connection.attach(c,d,e,function(a){b._onConnected(a,!0)})},_hasActiveConnection:function(){return!!(this._getParam("rid")&&this._getParam("sid")&&this._getParam("xmpp_domain"))},_onError:function(a){a==Strophe.Status.ERROR},_onConnected:function(a,b){if(Strophe.Status.CONNECTING==a||Strophe.Status.AUTHENTICATING==a)this.log("XMPP Connecting...");else if(Strophe.Status.CONNECTED==a||Strophe.Status.ATTACHED==a){var c=this;if(Strophe.Status.CONNECTED==a){this.log("XMPP Connected"),this._setParam("full_jid",this._connection.jid);var d=$iq({type:"set",to:"pubsub."+this._getParam("xmpp_domain")}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:"user:"+this._getParam("xmpp_username"),jid:this._connection.jid});this._connection.send(d)}else this.log("XMPP Re-Attached");this._connection.addHandler(function(a){return c._onMessage(a),!0},null,"message"),this._sendEvent({name:Cti.EVENT.READY,message:"Connection with XMPP server has been successfully established."})}else Strophe.Status.CONNFAIL==a?this.log("XMPP _connection fail"):Strophe.Status.DISCONNECTING==a?this.log("XMPP disconnecting"):Strophe.Status.DISCONNECTED==a?(this.log("XMPP disconnected"),this.isConnected()&&this.logout()):this.log("Strophe unhandled status: "+a)},_onMessage:function(a){var b=a.getAttribute("type");if(Cti.TYPE.ERROR===b)return!0;if(Cti.TYPE.HEADLINE===b)for(var c=a.getElementsByTagName("items"),d=0;d<c.length;d++){var e=c[d];if(e.getElementsByTagName("call").length>0){var f=a.getElementsByTagName("call")[0],g=this._nodeToArray(f),h=g.State,i=g.Id;if("ENDPOINT"===g.Context){if(0!==i.indexOf("c2c"))return void this.log("Invalid id: "+i);var j=i.substring(3);h===Cti.CALL_STATUS.ACCEPTED?this._handleEndpointAccepted(j,g):h===Cti.CALL_STATUS.INITIAL?this._handleEndpointInitial(j,g):this._handleEndpointNotAccepted(j,g)}else{var k=this._getCallDirection(g);if(k===Cti.DIRECTION.IN){var j=i;Cti.CALL_STATUS.CONNECTED===h&&this._handleInboundCallConnected(j,g),Cti.CALL_STATUS.RINGING===h&&this._handleInboundCallRinging(j,g),Cti.CALL_STATUS.ON_HOLD===h&&this._handleInboundCallOnHold(j,g),Cti.CALL_STATUS.HANGUP===h&&this._handleInboundCallHangUp(j,g)}if(k===Cti.DIRECTION.OUT){if("undefined"==typeof g.ReferredBy)var j=i;else{if(0!==g.ReferredBy.indexOf("c2c"))return void this.log("Invalid thread: "+g.ReferredBy);var j=g.ReferredBy.substring(3)}Cti.CALL_STATUS.CONNECTED===h&&this._handleOutboundCallConnected(j,g),Cti.CALL_STATUS.RINGING===h&&this._handleOutboundCallRinging(j,g),Cti.CALL_STATUS.ON_HOLD===h&&this._handleOutboundCallOnHold(j,g),Cti.CALL_STATUS.HANGUP===h&&this._handleOutboundCallHangUp(j,g)}}}}else if(Cti.TYPE.CHAT===b){if(void 0!==a.getAttribute("id")){var i=a.getAttribute("id");if(0!==i.indexOf("c2c"))return;var j=i.substring(3);if(a.getElementsByTagName("body").length>0){var l=a.getElementsByTagName("body")[0],m=l.textContent||l.text;m.indexOf("Error")>-1&&this._handleEndpointError(j,m)}}}else this.log("Undefined type: "+b);return!0},_handleInboundCallConnected:function(a,b){this._handleCallConnected(a,b)},_handleOutboundCallConnected:function(a,b){if(!this._hasCall(a)){var c=["IVR","TEST_CALL","CONF","VM","VM_MAIN","PICKUP_PARKED"];if(c.indexOf(b.Context)>=0){var d={id:a,cid:b.Id,cause:"",status:Cti.CALL_STATUS.CONNECTED,direction:Cti.DIRECTION.OUT,destination:b.Dst,destinationName:b.DstName,source:b.Src,sourceName:b.SrcName};this._setCall(a,d)}}this._handleCallConnected(a,b)},_handleCallConnected:function(a,b){if(this._hasCall(a)){var c=this._getCall(a);c.cid=b.Id,c.status=Cti.CALL_STATUS.CONNECTED,this._setCall(a,c),this._sendEvent({name:Cti.EVENT.CONNECTED,call:c})}},_handleInboundCallRinging:function(a,b){this.log("_handleInboundCallRinging");var c={id:a,cid:a,cause:"",status:Cti.CALL_STATUS.RINGING,direction:Cti.DIRECTION.IN,destination:b.Dst,destinationName:b.DstName,source:b.Src,sourceName:b.SrcName};this._setCall(a,c),this._sendEvent({name:Cti.EVENT.RINGING,call:c})},_handleOutboundCallRinging:function(a,b){if(this._hasCall(a)){var c=this._getCall(a);c.cid=b.Id,c.status=Cti.CALL_STATUS.RINGING,this._setCall(a,c)}else{var c={id:a,cid:b.Id,cause:"",status:Cti.CALL_STATUS.RINGING,direction:Cti.DIRECTION.OUT,destination:b.Dst,destinationName:b.DstName,source:b.Src,sourceName:b.SrcName};this._setCall(a,c)}this._sendEvent({name:Cti.EVENT.RINGING,call:c})},_handleInboundCallOnHold:function(a,b){this._handleCallOnHold(a,b)},_handleOutboundCallOnHold:function(a,b){if(!this._hasCall(a)&&"Queue"==b.Context){var c={id:a,cid:b.Id,cause:"",status:Cti.CALL_STATUS.ON_HOLD,direction:Cti.DIRECTION.OUT,destination:b.Dst,destinationName:b.DstName,source:b.Src,sourceName:b.SrcName};this._setCall(a,c)}this._handleCallOnHold(a,b)},_handleCallOnHold:function(a,b){if(this._hasCall(a)){var c=this._getCall(a);c.status=Cti.CALL_STATUS.ON_HOLD,this._setCall(a,c),this._sendEvent({name:Cti.EVENT.ON_HOLD,call:c})}},_handleInboundCallHangUp:function(a,b){this._handleCallHangUp(a,b)},_handleOutboundCallHangUp:function(a,b){this._handleCallHangUp(a,b)},_handleCallHangUp:function(a,b){if(this._hasCall(a)){var c=this._getCall(a);c.status=Cti.CALL_STATUS.HANGUP,c.cause=b["Cause-txt"]+" ("+b.Cause+")",this._setCall(a,c),this._sendEvent({name:Cti.EVENT.HANGUP,call:c})}},_handleEndpointInitial:function(a,b){if(this._hasCall(a)){var c=this._getCall(a),d=b.SrcContact;c.contacts.indexOf(d)<0&&(c.contacts.push(d),this._setCall(a,c)),c.status||(c.status=Cti.CALL_STATUS.INITIAL,this._setCall(a,c),this._sendEvent({name:Cti.EVENT.INITIAL,call:c}))}},_handleEndpointAccepted:function(a,b){if(this._hasCall(a)){var c=this._getCall(a),d=b.Cause,e=b.SrcContact;if(Cti.CALL_CODE.ACCEPTED!=d)return void this._sendErrorEvent("Unexpected endpoint status: "+d);c.contacts.length>1&&(c.contacts=new Array(e)),c.status=Cti.CALL_STATUS.ACCEPTED,this._setCall(a,c),this._sendEvent({name:Cti.EVENT.ACCEPTED,call:c})}},_handleEndpointNotAccepted:function(a,b){if(this._hasCall(a)){var c=this._getCall(a),d=b.SrcContact,e=c.contacts.indexOf(d);e>-1&&(c.contacts.splice(e,1),this._setCall(a,c)),0===c.contacts.length&&(c.status=Cti.CALL_STATUS.HANGUP,this._setCall(a,c),this._handleEndpointError(a,'SIP Endpoint returned "'+b["Cause-txt"]+'" ('+b.Cause+")"))}},_handleEndpointError:function(a,b){if(this._hasCall(a)){var c=this._getCall(a);c.cause=b,this._setCall(a,c),this._fireCancelEvent(a)}},_fireCancelEvent:function(a){if(this._hasCall(a)){var b=this._getCall(a);this._sendEvent({name:Cti.EVENT.CANCEL,call:b}),this._removeCall(a)}},_newXHR:function(){var a=null;if(window.XDomainRequest){this.log("using XdomainRequest for IE");var b=function(a,b){a.status=b,a.readyState=4;try{a.onreadystatechange()}catch(a){}},a=new XDomainRequest;a.readyState=0,a.onload=function(){xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(a.responseText),a.responseXML=xmlDoc,b(a,200)},a.onerror=function(){b(a,500)},a.ontimeout=function(){b(a,500)}}else window.XMLHttpRequest?(this.log("using XMLHttpRequest"),a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(this.log("using ActiveXObject"),a=new ActiveXObject("Microsoft.XMLHTTP"));return a},_nodeToArray:function(a){for(var b=a.childNodes,c={},d=0;d<b.length;d++){var a=b[d],e=a.textContent||a.text;c[a.nodeName]=e}return c},_getCallDirection:function(a){return a.SrcId?a.DstId?a.SrcId==this._getParam("xmpp_username")?Cti.DIRECTION.OUT:Cti.DIRECTION.IN:Cti.DIRECTION.OUT:Cti.DIRECTION.IN},_formatE164:function(a){return"+"+a.replace(/\+|\-|\.|\(|\)| /g,"").replace(/^0{1,2}/g,"")},_isPhoneNumberValid:function(a){return/^\+[1-9][0-9]{5,16}$/.test(a)},_isExtensionValid:function(a){return/^[1-9][0-9]{3,4}$/.test(a)},_sendEvent:function(a){this.callbacks.onMessage(a)},_sendInfoEvent:function(a){this._sendEvent({name:Cti.EVENT.INFO,message:a})},_sendErrorEvent:function(a){this._sendEvent({name:Cti.EVENT.ERROR,message:a})},_setParam:function(a,b){var c=this._getParams();return c[a]=b,this._setCookie("l7_connector",c),this},_getParam:function(a,b){var c=this._getParams();return void 0!==c[a]?c[a]:b},_getParams:function(){return this._getCookie("l7_connector",{})},_getCookie:function(a,b){for(var c=document.cookie?document.cookie.split("; "):[],d=0,e=c.length;d<e;d++){var f=c[d].split("="),g=decodeURIComponent(f.shift()),h=f.join("=");if(a&&a===g)return JSON.parse(h)}return void 0!==b?b:void 0},_setCookie:function(a,b,c){var c=void 0===c?{}:c;if("number"==typeof c.expires){var d=c.expires,e=c.expires=new Date;e.setTime(+e+864e5*d)}document.cookie=[a,"=",JSON.stringify(b),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure||this._isSecured()?"; secure":""].join("")},_removeCookie:function(a){return this._setCookie(a,"",{expires:-1})},_isSecured:function(){return"https:"==window.location.protocol},_getCalls:function(){return this._getParam("calls",{})},_setCalls:function(a){return this._setParam("calls",a)},_hasCall:function(a){var b=this._getCalls();return a in b},_getCall:function(a){return this._hasCall(a)?this._getCalls()[a]:null},_setCall:function(a,b){var c=this._getCalls();if(c.hasOwnProperty(a)){var d=c[a];d.status!==b.status&&this.log("Call status changed to: "+b.status)}c[a]=b,this._setCalls(c)},_removeCall:function(a){if(!this._hasCall(a))return null;var b=this._getCalls();delete b[a],this._setCalls(b)},_serialize:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},_uniqid:function(){return(new Date).getTime()}};
