/*! cti-connector.js v1.0.6 - built on 31-05-2017 */
Cti={EVENT:{READY:"READY",LOGGED_IN:"LOGGED_IN",LOGGED_OUT:"LOGGED_OUT",INITIAL:"INITIAL",ACCEPTED:"ACCEPTED",RINGING:"RINGING",CONNECTED:"CONNECTED",ON_HOLD:"ON_HOLD",HANGUP:"HUNGUP",CANCEL:"CANCEL",INFO:"INFO",ERROR:"ERROR"},DIRECTION:{IN:"INBOUND",OUT:"OUTBOUND"},TYPE:{ERROR:"error",CHAT:"chat",HEADLINE:"headline",UNAVAILABLE:"unavailable"},CALL_STATUS:{INITIAL:"INITIAL",ACCEPTED:"ACCEPTED",RINGING:"RINGING",ON_HOLD:"ON_HOLD",CONNECTED:"CONNECTED",HANGUP:"HANGUP"},CALL_CODE:{RINGING:/^1\d{2}$/,ACCEPTED:200,REDIRECTED:/^3\d{2}$/,NO_ANSWER:487,UNREACHABLE:408,NOT_FOUND:/^4\d{2}$/,REJECTED:/^[5|6]\d{2}$/},log:function(t){window.console&&("string"==typeof t&&(t="Cti: "+t),console.info(t))}},"undefined"!=typeof Strophe&&(Strophe.log=function(t,e){t>=Strophe.LogLevel.INFO&&window.console&&console.log("STROPHE LOG: "+t+" "+e)}),Cti.Connector=function(t){this.connected=!1,this.apiLoginUrl="https://ssl7.net/voipstudio.com/u/api/login",this.callbacks={onMessage:t.onMessage},this.xhr=this._newXHR(),this._hasActiveConnection()&&this._reconnect()},Cti.Connector.prototype={isConnected:function(){return this.log("isConnected() "+this.connected),this.connected},log:function(t){window.console&&console.log("Cti.Connector: "+t)},login:function(){if(this._connection instanceof Strophe.Connection&&this._connection.connected)return this.log("Already connected"),this.connected=!0,void this._sendEvent({name:Cti.EVENT.LOGGED_IN,message:"User is already authenticated."});if(0===arguments.length||arguments.length>2)this._sendErrorEvent("Invalid aruments number while login.");else{if(1==arguments.length){var t=arguments[0];if(0===t.length)return void this._sendErrorEvent("Missing username and/or password.");i={api_key:t,protocol:"xmpp"}}else{var e=arguments[0],n=arguments[1];if(0===e.length||0===n.length)return void this._sendErrorEvent("Missing username and/or password.");var i={api_email:e,api_password:n,protocol:"xmpp"}}var s=this;this.xhr.open("POST",this.apiLoginUrl,!0),"withCredentials"in this.xhr&&(this.xhr.withCredentials=!0),this.xhr.onreadystatechange=function(){if(4===s.xhr.readyState)if(200===s.xhr.status||304===s.xhr.status){var t=JSON.parse(s.xhr.responseText);t.success?(s.log("ajax login SUCCESS"),s._setCalls({}),s.connected=!0,s._sendEvent({name:Cti.EVENT.LOGGED_IN,message:"User has been successfully authenticated."}),s._connect(t.xmpp_username,t.xmpp_password,t.xmpp_domain)):s._sendErrorEvent(t.error)}else s.log("ajax login FAIL"),s._sendErrorEvent("Unable to login")},this.xhr.send(this._serialize(i))}},logout:function(){if(this.isConnected())return this.connected=!1,this._setCookie("l7_connector",{}),this._connection.connected&&this._connection.disconnect("logout"),this._sendEvent({name:Cti.EVENT.LOGGED_OUT,message:"User has been successfully logged out."});this._sendErrorEvent("Connector is not connected.")},call:function(t){if(this.isConnected())if(void 0!==t)if(0!==t.length){if(t.length>5){if(t=this._formatE164(t),!this._isPhoneNumberValid(t))return void this._sendErrorEvent("Phone number: "+t+" has invalid format")}else if(this._getParam("xmpp_username")==t)return void this._sendErrorEvent("You are unable to call to yourself.");var e=this._uniqid(),n={id:e,cid:"",cause:"",status:"",direction:Cti.DIRECTION.OUT,destination:t,contacts:new Array};this._setCall(e,n),this.log("Call: "+t);var i="/call "+t,s=$msg({to:"cc@"+this._getParam("xmpp_domain"),type:"chat",id:"c2c"+e}).c("body",{},i);this._connection.send(s.tree())}else this._sendErrorEvent("Destination number is empty");else this._sendErrorEvent("Missing destination parameter");else this._sendErrorEvent("Connector need to be connected first.")},terminate:function(t){if(this.isConnected())if(void 0!==t)if(this._hasCall(t)){var e=this._getCall(t,!0);if(-1!=[Cti.CALL_STATUS.CONNECTED,Cti.CALL_STATUS.ON_HOLD].indexOf(e.status)){this.log("HangUp: "+e.cid);var n="/terminate "+e.cid,i=$msg({to:"cc@"+this._getParam("xmpp_domain"),type:"chat",id:"c2c"+e.cid}).c("body",{},n);this._connection.send(i.tree())}else this._sendInfoEvent("Call with STATUS: "+e.status+" cannot be terminated.")}else this._sendErrorEvent("Call with ID: "+t+" could not be found.");else this._sendErrorEvent("Missing call ID parameter");else this._sendErrorEvent("Connector need to be connected first.")},transfer:function(t,e){if(this.isConnected())if(void 0!==t)if(void 0!==e)if(this._hasCall(t)){var n=this._getCall(t,!0);if(n.status===Cti.CALL_STATUS.CONNECTED)if(0!==e.length){if(e.length>5){if(e=this._formatE164(e),!this._isPhoneNumberValid(e))return void this._sendErrorEvent("Phone number: "+e+" has invalid format")}else{if(!this._isExtensionValid(e))return void this._sendErrorEvent("Extension number: "+e+" has invalid format");if(this._getParam("xmpp_username")==e)return void this._sendErrorEvent("You are unable to transfer call to yourself.")}n.destination=e,this._setCall(t,n),this.log("Transfer: "+n.cid+" "+n.destination);var i="/transfer "+n.cid+" "+n.destination,s=$msg({to:"cc@"+this._getParam("xmpp_domain"),type:"chat",id:"c2c"+n.cid}).c("body",{},i);this._connection.send(s.tree())}else this._sendErrorEvent("Destination number is empty");else this._sendInfoEvent("Call with STATUS: "+n.status+" cannot be transfered.")}else this._sendErrorEvent("Call with ID: "+t+" could not be found.");else this._sendErrorEvent("Missing destination parameter");else this._sendErrorEvent("Missing call ID parameter");else this._sendErrorEvent("Connector need to be connected first.")},subscribe:function(t){if(void 0!==t)if(this.isConnected()){var e=t.split(":");if(2==e.length){var n=["user","ivr","queue","conf"],i=e.shift();if(n.indexOf(i)<0)this._sendErrorEvent("Invalid node type.");else{var s=$iq({id:this._connection.getUniqueId("sub"),type:"set",to:"pubsub."+this._getParam("xmpp_domain")}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:t,jid:this._connection.jid});this._connection.send(s)}}else this._sendErrorEvent("Invalid node format.")}else this._sendErrorEvent("Connector need to be connected first.");else this._sendErrorEvent("Missing node parameter.")},_connect:function(t,e,n){if(t)if(e)if(n){var i="https://"+n+"/http-bind",s=t+"@"+n,o=this;this._setParam("xmpp_domain",n),this._setParam("xmpp_username",t),this._connection=new Strophe.Connection(i),this._connection.xmlOutput=function(t){o._setParam("rid",t.getAttribute("rid"))},this._connection.connect(s,e,function(t){o._setParam("sid",o._connection._proto.sid),o._onConnected(t,!1)})}else this._sendErrorEvent("Empty xmpp_domain given");else this._sendErrorEvent("Empty xmpp_password given");else this._sendErrorEvent("Empty xmpp_username given")},_reconnect:function(){if(this._getCookie("l7_connector"))if(this._getParam("rid")&&this._getParam("sid")){var t="https://"+this._getParam("xmpp_domain")+"/http-bind",e=this;this._connection=new Strophe.Connection(t),this._connection.xmlOutput=function(t){e._setParam("rid",t.getAttribute("rid"))},this.connected=!0;var n=this._getParam("full_jid"),i=this._getParam("sid"),s=parseInt(this._getParam("rid"))+1;this._connection.attach(n,i,s,function(t){e._onConnected(t,!0)})}else this._sendErrorEvent("You need to login first in order to be able to reconnect to XMPP server.");else this._sendErrorEvent("You need to login first in order to be able to connect to XMPP server.")},_hasActiveConnection:function(){return!!(this._getParam("rid")&&this._getParam("sid")&&this._getParam("xmpp_domain"))},_onError:function(t){Strophe.Status.ERROR},_onConnected:function(t,e){if(Strophe.Status.CONNECTING==t||Strophe.Status.AUTHENTICATING==t)this.log("XMPP Connecting...");else if(Strophe.Status.CONNECTED==t||Strophe.Status.ATTACHED==t){var n=this;if(Strophe.Status.CONNECTED==t){this.log("XMPP Connected"),this._setParam("full_jid",this._connection.jid);var i=$iq({id:this._connection.getUniqueId("sub"),type:"set",to:"pubsub."+this._getParam("xmpp_domain")}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:"user:"+this._getParam("xmpp_username"),jid:this._connection.jid});this._connection.send(i)}else this.log("XMPP Re-Attached");this._connection.addHandler(function(t){return n._onMessage(t),!0},null,"message"),this._sendEvent({name:Cti.EVENT.READY,message:"Connection with XMPP server has been successfully established."})}else Strophe.Status.CONNFAIL==t?this.log("XMPP _connection fail"):Strophe.Status.DISCONNECTING==t?this.log("XMPP disconnecting"):Strophe.Status.DISCONNECTED==t?(this.log("XMPP disconnected"),this.isConnected()&&this.logout()):this.log("Strophe unhandled status: "+t)},_onMessage:function(t){var e=t.getAttribute("type");if(Cti.TYPE.ERROR===e)return!0;if(Cti.TYPE.HEADLINE===e){for(var n=t.getElementsByTagName("items"),i=0;i<n.length;i++)if(n[i].getElementsByTagName("call").length>0){var s=t.getElementsByTagName("call")[0],o=this._nodeToArray(s),a=o.State,r=o.Id;if("ENDPOINT"===o.Context){if(0!==r.indexOf("c2c"))return void this.log("Invalid id: "+r);c=r.substring(3);a===Cti.CALL_STATUS.ACCEPTED?this._handleEndpointAccepted(c,o):a===Cti.CALL_STATUS.INITIAL?this._handleEndpointInitial(c,o):this._handleEndpointNotAccepted(c,o)}else{var l=this._getCallDirection(o);if(l===Cti.DIRECTION.IN){c=r;Cti.CALL_STATUS.CONNECTED===a&&this._handleInboundCallConnected(c,o),Cti.CALL_STATUS.RINGING===a&&this._handleInboundCallRinging(c,o),Cti.CALL_STATUS.ON_HOLD===a&&this._handleInboundCallOnHold(c,o),Cti.CALL_STATUS.HANGUP===a&&this._handleInboundCallHangUp(c,o)}if(l===Cti.DIRECTION.OUT){if(void 0===o.ReferredBy)c=r;else{if(0!==o.ReferredBy.indexOf("c2c"))return void this.log("Invalid thread: "+o.ReferredBy);c=o.ReferredBy.substring(3)}Cti.CALL_STATUS.CONNECTED===a&&this._handleOutboundCallConnected(c,o),Cti.CALL_STATUS.RINGING===a&&this._handleOutboundCallRinging(c,o),Cti.CALL_STATUS.ON_HOLD===a&&this._handleOutboundCallOnHold(c,o),Cti.CALL_STATUS.HANGUP===a&&this._handleOutboundCallHangUp(c,o)}}}}else if(Cti.TYPE.CHAT===e){if(void 0!==t.getAttribute("id")){if(0!==(r=t.getAttribute("id")).indexOf("c2c"))return;var c=r.substring(3);if(t.getElementsByTagName("body").length>0){var d=t.getElementsByTagName("body")[0],h=d.textContent||d.text;h.indexOf("Error")>-1&&this._handleEndpointError(c,h)}}}else this.log("Undefined type: "+e);return!0},_handleInboundCallConnected:function(t,e){this._handleCallConnected(t,e)},_handleOutboundCallConnected:function(t,e){if(!this._hasCall(t)&&["IVR","TEST_CALL","CONF","VM","VM_MAIN","PICKUP_PARKED"].indexOf(e.Context)>=0){var n={id:t,cid:e.Id,cause:"",status:Cti.CALL_STATUS.CONNECTED,direction:Cti.DIRECTION.OUT,destination:e.Dst,destinationName:e.DstName,source:e.Src,sourceName:e.SrcName};this._setCall(t,n)}this._handleCallConnected(t,e)},_handleCallConnected:function(t,e){if(this._hasCall(t)){var n=this._getCall(t);n.cid=e.Id,n.status=Cti.CALL_STATUS.CONNECTED,this._setCall(t,n),this._sendEvent({name:Cti.EVENT.CONNECTED,call:n})}},_handleInboundCallRinging:function(t,e){this.log("_handleInboundCallRinging");var n={id:t,cid:t,cause:"",status:Cti.CALL_STATUS.RINGING,direction:Cti.DIRECTION.IN,destination:e.Dst,destinationName:e.DstName,source:e.Src,sourceName:e.SrcName};this._setCall(t,n),this._sendEvent({name:Cti.EVENT.RINGING,call:n})},_handleOutboundCallRinging:function(t,e){if(this._hasCall(t))(n=this._getCall(t)).cid=e.Id,n.status=Cti.CALL_STATUS.RINGING,this._setCall(t,n);else{var n={id:t,cid:e.Id,cause:"",status:Cti.CALL_STATUS.RINGING,direction:Cti.DIRECTION.OUT,destination:e.Dst,destinationName:e.DstName,source:e.Src,sourceName:e.SrcName};this._setCall(t,n)}this._sendEvent({name:Cti.EVENT.RINGING,call:n})},_handleInboundCallOnHold:function(t,e){this._handleCallOnHold(t,e)},_handleOutboundCallOnHold:function(t,e){if(!this._hasCall(t)&&"Queue"==e.Context){var n={id:t,cid:e.Id,cause:"",status:Cti.CALL_STATUS.ON_HOLD,direction:Cti.DIRECTION.OUT,destination:e.Dst,destinationName:e.DstName,source:e.Src,sourceName:e.SrcName};this._setCall(t,n)}this._handleCallOnHold(t,e)},_handleCallOnHold:function(t,e){if(this._hasCall(t)){var n=this._getCall(t);n.status=Cti.CALL_STATUS.ON_HOLD,this._setCall(t,n),this._sendEvent({name:Cti.EVENT.ON_HOLD,call:n})}},_handleInboundCallHangUp:function(t,e){this._handleCallHangUp(t,e)},_handleOutboundCallHangUp:function(t,e){this._handleCallHangUp(t,e)},_handleCallHangUp:function(t,e){if(this._hasCall(t)){var n=this._getCall(t);n.status=Cti.CALL_STATUS.HANGUP,n.cause=e["Cause-txt"]+" ("+e.Cause+")",this._setCall(t,n),this._sendEvent({name:Cti.EVENT.HANGUP,call:n})}},_handleEndpointInitial:function(t,e){if(this._hasCall(t)){var n=this._getCall(t),i=e.SrcContact;n.contacts.indexOf(i)<0&&(n.contacts.push(i),this._setCall(t,n)),n.status||(n.status=Cti.CALL_STATUS.INITIAL,this._setCall(t,n),this._sendEvent({name:Cti.EVENT.INITIAL,call:n}))}},_handleEndpointAccepted:function(t,e){if(this._hasCall(t)){var n=this._getCall(t),i=e.Cause,s=e.SrcContact;Cti.CALL_CODE.ACCEPTED==i?(n.contacts.length>1&&(n.contacts=new Array(s)),n.status=Cti.CALL_STATUS.ACCEPTED,this._setCall(t,n),this._sendEvent({name:Cti.EVENT.ACCEPTED,call:n})):this._sendErrorEvent("Unexpected endpoint status: "+i)}},_handleEndpointNotAccepted:function(t,e){if(this._hasCall(t)){var n=this._getCall(t),i=e.SrcContact,s=n.contacts.indexOf(i);s>-1&&(n.contacts.splice(s,1),this._setCall(t,n)),0===n.contacts.length&&(n.status=Cti.CALL_STATUS.HANGUP,this._setCall(t,n),this._handleEndpointError(t,'SIP Endpoint returned "'+e["Cause-txt"]+'" ('+e.Cause+")"))}},_handleEndpointError:function(t,e){if(this._hasCall(t)){var n=this._getCall(t);n.cause=e,this._setCall(t,n),this._fireCancelEvent(t)}},_fireCancelEvent:function(t){if(this._hasCall(t)){var e=this._getCall(t);this._sendEvent({name:Cti.EVENT.CANCEL,call:e}),this._removeCall(t)}},_newXHR:function(){var t=null;if(window.XDomainRequest){this.log("using XdomainRequest for IE");var e=function(t,e){t.status=e,t.readyState=4;try{t.onreadystatechange()}catch(t){}};(t=new XDomainRequest).readyState=0,t.onload=function(){xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(t.responseText),t.responseXML=xmlDoc,e(t,200)},t.onerror=function(){e(t,500)},t.ontimeout=function(){e(t,500)}}else window.XMLHttpRequest?(this.log("using XMLHttpRequest"),(t=new XMLHttpRequest).overrideMimeType&&t.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(this.log("using ActiveXObject"),t=new ActiveXObject("Microsoft.XMLHTTP"));return t},_nodeToArray:function(t){for(var e=t.childNodes,n={},i=0;i<e.length;i++){var s=(t=e[i]).textContent||t.text;n[t.nodeName]=s}return n},_getCallDirection:function(t){return t.SrcId?t.DstId?t.SrcId==this._getParam("xmpp_username")?Cti.DIRECTION.OUT:Cti.DIRECTION.IN:Cti.DIRECTION.OUT:Cti.DIRECTION.IN},_formatE164:function(t){return"+"+t.replace(/\+|\-|\.|\(|\)| /g,"").replace(/^0{1,2}/g,"")},_isPhoneNumberValid:function(t){return/^\+[1-9][0-9]{5,16}$/.test(t)},_isExtensionValid:function(t){return/^[1-9][0-9]{3,4}$/.test(t)},_sendEvent:function(t){this.callbacks.onMessage(t)},_sendInfoEvent:function(t){this._sendEvent({name:Cti.EVENT.INFO,message:t})},_sendErrorEvent:function(t){this._sendEvent({name:Cti.EVENT.ERROR,message:t})},_setParam:function(t,e){var n=this._getParams();return n[t]=e,this._setCookie("l7_connector",n),this},_getParam:function(t,e){var n=this._getParams();return void 0!==n[t]?n[t]:e},_getParams:function(){return this._getCookie("l7_connector",{})},_getCookie:function(t,e){for(var n=document.cookie?document.cookie.split("; "):[],i=0,s=n.length;i<s;i++){var o=n[i].split("="),a=decodeURIComponent(o.shift()),r=o.join("=");if(t&&t===a)return JSON.parse(r)}return void 0!==e?e:void 0},_setCookie:function(t,e,n){if("number"==typeof(n=void 0===n?{}:n).expires){var i=n.expires,s=n.expires=new Date;s.setTime(+s+864e5*i)}document.cookie=[t,"=",JSON.stringify(e),n.expires?"; expires="+n.expires.toUTCString():"",n.path?"; path="+n.path:"",n.domain?"; domain="+n.domain:"",n.secure||this._isSecured()?"; secure":""].join("")},_removeCookie:function(t){return this._setCookie(t,"",{expires:-1})},_isSecured:function(){return"https:"==window.location.protocol},_getCalls:function(){return this._getParam("calls",{})},_setCalls:function(t){return this._setParam("calls",t)},_hasCall:function(t){return t in this._getCalls()},_getCall:function(t){return this._hasCall(t)?this._getCalls()[t]:null},_setCall:function(t,e){var n=this._getCalls();n.hasOwnProperty(t)&&n[t].status!==e.status&&this.log("Call status changed to: "+e.status),n[t]=e,this._setCalls(n)},_removeCall:function(t){if(!this._hasCall(t))return null;var e=this._getCalls();delete e[t],this._setCalls(e)},_serialize:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")},_uniqid:function(){return(new Date).getTime()}};
